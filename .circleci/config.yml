version: 2

orbs:
    slack: circleci/slack@2.0.0
    aws-ecr: circleci/aws-ecr@3.1.0
    aws-ecs: circleci/aws-ecs@0.0.7
    aws-cli: circleci/aws-cli@0.1.4

jobs:
  build_and_test:
    docker:
      - image: docker:18.06.1-ce-git
    working_directory: ~/CircleCI/docker-airflow
    steps:
      - checkout
      - setup_remote_docker:
          docker_layer_caching: true
      - run: 
          name: Build docker image
          command: |
            docker build -t singuli/docker-airflow .
      - run: 
          name: Test docker image
          command: |
            docker run singuli/docker-airflow version | grep '1.10.2'
      - aws-ecr/build-and-push-image:
          aws-access-key-id: DEV_AWS_ACCESS_KEY
          aws-secret-access-key: DEV_AWS_SECRET_KEY
          region: DEV_AWS_REGION
          account-url: DEV_AWS_ECR_URL
          repo: 'singuli-dev_repository'
          tag: 'airflow:latest'
workflows:
  version: 2
  build_and_test:
    jobs:
      - build_and_test
